<!DOCTYPE html>
<html>
<head>
  <title>vote页面</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
  <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/1.1.2/weui.min.css"/>
  <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
  <script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>

  <script src="https://unpkg.com/vue"></script>

  <style>

  .page-container{
    padding:20px 0 0 0;
  }
  .text-center{
    text-align: center;
  }
  .wechat-font-h1{
    font-size: 2.5em;
  }
  .wechat-font-h2{
    font-size: 2em;
  }
  .wechat-font-h3{
    font-size: 1.5em;
  }
  .wechat-float-left{
    float: left
  }
  .wechat-float-right{
    float: right
  }
  .toupiao,.shangchuan{
    margin: 0em 1.4em;
  }
  .weui-uploader__bd{
    margin: 0;
  }
  .weui-uploader__input-box{
    margin: 0.8em 1em;
  }
  .introduction{
    padding: 0 1.6em;
    margin-top: 1em;
  }
  .wechat-article{
    background: #eee;
    border-radius: 0.4em;
    width: 100%;
    padding: 10px 15px;
  }
  .wechat-section-lastone{
    margin-bottom: 0 !important;
  }

  .wechat-upload-picwrapper{
    padding: 20px;
    height: 300px;
  }

  #compressedPic{
    width: 100%;
  }

  </style>

</head>
<body>

  <div id="app">
    <div class="page-container" v-show="page === 'upload' ">
      <div class="weui-flex wechat-upload-picwrapper">
          <img id="compressedPic" src="" />
      </div>
    </div>

    <div class="page-container" v-show="page === 'main' ">
      <!-- title -->
      <div class="weui-flex text-center wechat-font-h1">
        <div class="weui-flex__item">最创意</div>
      </div>

      <div class="weui-flex text-center wechat-font-h3">
        <div class="weui-flex__item">拍照姿（知）势（识）</div>
      </div>

      <div class="weui-flex text-center wechat-font-h1">
        <div class="weui-flex__item">赢大奖</div>
      </div>

      <!-- 投票 -->
      <div class="weui-flex ">

        <div class="weui-flex__item" @click="vote()">
          <div class="weui-uploader">
              <div class="weui-uploader__bd ">
                  <div class="weui-uploader__input-box wechat-float-right">
                      <!-- <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" multiple /> -->
                  </div>
              </div>
          </div>

          <div class="toupiao wechat-float-right" >我要投票</div>

        </div>

        <div class="weui-flex__item">
          <div class="weui-uploader">
              <div class="weui-uploader__bd ">
                  <div class="weui-uploader__input-box wechat-float-left">
                      <input id="uploaderInput_upload" class="weui-uploader__input" type="file" accept="image/*" multiple />
                  </div>
              </div>
          </div>

          <!-- <img id="compressedPic" src =""/> -->
          <div class="shangchuan wechat-float-left">我要上传</div>

        </div>
      </div>

      <div class="weui-flex introduction">
        <article class="weui-article wechat-article ">
            <h1>活动说明</h1>

            <section class="wechat-section-lastone">
                <h3>1.文案文案文案文案文案文案文案文案</h3>
                <h3>2.文案文案文案文案文案文案文案文案</h3>
                <h3>3.文案文案文案文案文案文案文案文案</h3>
                <h3>4.文案文案文案文案文案文案文案文案</h3>
                <h3>5.文案文案文案文案文案文案文案文案</h3>
                <h3>（文案文案文案文案文案文案文案文案）</h3>
            </section>

        </article>
      </div>

    </div>


  </div>


  <script>
    var vue = new Vue({
      el: '#app',
      data: {
        page:"main", // main , mypic , list
        picdata:null,
      },
      methods: {
        changePage:function(page){
          var vm = this;
          vm.page = page;
        },
        vote:function(){
          var vm = this;
          vm.changePage("vote");
        },
        setUserPic:function(base64){
          var vm = this;
          vm.picdata = base64;
        }
      }
    })
  </script>

  <script>
    var serverip = 'http://myvote.leanapp.cn'
    var server = {
      getCookie : function(key){
        return $.cookie(key)
      },
      setCookie : function(key,value){
        $.cookie(key, value , { path: '/' });
        return $.cookie(key)
      },
      setLocalStorage:function(key,value){
        localStorage.setItem(key,value);
      },
      setLocalStorage:function(key){
        localStorage.getItem(key);
      },
      ajax(url,method,data){
        url = serverip + url
        return $.ajax({
          url:url,
          type:method,
          data:data
        })
      }
    };

    (function(global){
      if(!global.getCookie('token')){
        global.ajax('/user/create',"post",{
          "useragent": navigator.userAgent ? navigator.userAgent : ""
        }).then(function(response){
          console.log(response);
          if(response.success){
            console.log("set")
            userinfo = JSON.parse(response.data);
            global.setCookie("token",userinfo.token);
          }
        }).fail(function(error){
          console.log(error);
        })
      }else{

      }
    }(server))

  </script>

  <script>

  $(function () {
      // 允许上传的图片类型
      var allowTypes = ['image/jpg', 'image/jpeg', 'image/png', 'image/gif'];
      // 1024KB，也就是 4MB
      var maxSize = 1024 * 1024 * 4;
      // maxWidth
      var maxWidth = 150;
      // maxheight
      var maxHeight =150;

      $('#uploaderInput_upload').on('change', function (event) {
          var files = event.target.files;
          // 如果没有选中文件，直接返回
          if (files.length === 0) {
              return;
          }

          if (files.length >1) {
              $.weui.alert({text:'只能上传一张'});
          }

          var file = files[0];
          var reader = new FileReader();
          // 如果类型不在允许的类型范围内

          if (allowTypes.indexOf(file.type) === -1) {
              $.weui.alert({text: '该类型不允许上传'});
          }

          if(file.size > maxSize) {
              $.weui.alert({text:'文件过大'});
          }

          console.log('filename is ' + file.name);
          console.log('file original size is' + file.size);
          console.log('file type is ' + file.type);

          reader.readAsArrayBuffer(file);

          reader.onload = function (event) {
              // blob stuff
              console.log('file is already read in');
              var blob = new Blob([event.target.result]); // create blob...
              console.log(blob);
              window.URL = window.URL || window.webkitURL;
              var blobURL = window.URL.createObjectURL(blob); // and get it's URL

              // helper Image object
              var image = new Image();
              image.src = blobURL;
              console.log(image);
              image.onload = function(){
                  var resized = resizeMe(image);
                  uploadToCloud(resized);
              }
          };
      });

      function resizeMe(img) {
          var canvas = document.createElement('canvas');
          // width & height of the pic
          var width = img.width;
          var height = img.height;
          // calculate the width and height, constraining the proportions
          if (width > height) {
              if (width > maxWidth) {
                  //height *= max_width / width;
                  height = Math.round(height *= maxWidth / width);
                  width = maxWidth;
              }
          } else {
              if (height > maxHeight) {
                  //width *= max_height / height;
                  width = Math.round(width *= maxHeight / height);
                  height = maxHeight;
              }
          }

          // resize the canvas and draw the image data into it
          canvas.width = width;
          canvas.height = height;
          var ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);
          var base64 = canvas.toDataURL("image/jpeg",1); // get the data from canvas as 70% JPG (can be also PNG, etc.)

          document.getElementById('compressedPic').src = base64;

          return base64;
      }

      function uploadToCloud(base64){
          server.ajax('/upload','post',{
            "img": base64,
            "token" : server.getCookie("token")
          }).then(function(response){
            console.log(response)
            if(response.sucess){
              vue.changePage('upload');
              server.setLocalStorage('userupload',base64);
            }
          }).fail(function(error){
            console.log(error)
          })
      }

      function showlist(){

      }

      function vote(){

      }
  });

  </script>


</body>
</html>
